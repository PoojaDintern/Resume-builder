<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resume Analytics Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            padding-top: 80px;
        }
        .app-header {
            position: fixed; top: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            padding: 12px 30px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
        }
        .brand-logo {
            display: flex; align-items: center; gap: 12px;
            text-decoration: none;
        }
        .brand-icon {
            width: 42px; height: 42px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 20px;
        }
        .brand-text {
            font-size: 20px; font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .back-button {
            display: flex; align-items: center; gap: 8px;
            padding: 8px 16px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            text-decoration: none;
            color: #667eea;
            font-weight: 600;
            margin-left: 20px;
        }
        .header-left {
            display: flex;
            align-items: center;
        }
        .user-profile { position: relative; }
        .profile-trigger {
            display: flex; align-items: center; gap: 12px;
            padding: 8px 15px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px; cursor: pointer;
            transition: all 0.3s ease;
        }
        .profile-trigger:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            transform: translateY(-2px);
        }
        .user-avatar {
            width: 38px; height: 38px; border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: 700;
        }
        .profile-dropdown {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            min-width: 250px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1001;
        }
        .profile-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .dropdown-header {
            padding: 20px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .dropdown-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 20px;
        }
        .dropdown-user-info h4 {
            margin: 0;
            font-size: 16px;
            font-weight: 700;
            color: #333;
        }
        .dropdown-user-info p {
            margin: 5px 0 0;
            font-size: 13px;
            color: #666;
        }
        .dropdown-menu-items {
            padding: 10px 0;
        }
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: #333;
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .dropdown-item:hover {
            background: #f8f9fa;
        }
        .dropdown-item i {
            width: 20px;
            font-size: 16px;
            color: #667eea;
        }
        .dropdown-item.logout {
            color: #f44336;
            border-top: 2px solid #f0f0f0;
        }
        .dropdown-item.logout i {
            color: #f44336;
        }
        .dashboard-container { max-width: 1600px; margin: 0 auto; }
        .dashboard-header {
            background: white; padding: 30px; border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .dashboard-header h1 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700; font-size: 36px;
        }
        .back-btn, .btn-action {
            background: white; color: #667eea;
            border: 2px solid #667eea;
            padding: 12px 30px; border-radius: 12px;
            text-decoration: none; font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-action {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px; margin-bottom: 30px;
        }
        .stat-card {
            background: white; padding: 30px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            transition: all 0.4s ease;
            position: relative;
        }
        .stat-card::before {
            content: ''; position: absolute;
            top: 0; left: 0; width: 100%; height: 5px;
            border-radius: 20px 20px 0 0;
        }
        .stat-card.primary::before { background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); }
        .stat-card.success::before { background: linear-gradient(90deg, #56ab2f 0%, #a8e063 100%); }
        .stat-card.warning::before { background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%); }
        .stat-card.info::before { background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%); }
        .stat-card.visitor::before { background: linear-gradient(90deg, #FA8BFF 0%, #2BD2FF 90%); }
        .stat-card.download::before { background: linear-gradient(90deg, #F97794 0%, #623AA2 100%); }
        .stat-icon {
            width: 70px; height: 70px; border-radius: 15px;
            display: flex; align-items: center; justify-content: center;
            font-size: 32px; margin-bottom: 20px; color: white;
        }
        .stat-card.primary .stat-icon { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stat-card.success .stat-icon { background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%); }
        .stat-card.warning .stat-icon { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .stat-card.info .stat-icon { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .stat-card.visitor .stat-icon { background: linear-gradient(135deg, #FA8BFF 0%, #2BD2FF 90%); }
        .stat-card.download .stat-icon { background: linear-gradient(135deg, #F97794 0%, #623AA2 100%); }
        .stat-number { font-size: 42px; font-weight: 700; color: #333; }
        .stat-label {
            color: #666; font-size: 15px; font-weight: 500;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .chart-container {
            background: white; padding: 35px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            margin-bottom: 30px;
        }
        .chart-header {
            margin-bottom: 25px; padding-bottom: 15px;
            border-bottom: 3px solid #f0f0f0;
        }
        .chart-header h3 {
            color: #333; font-weight: 600; font-size: 22px;
        }
        .users-cards-section {
            background: white; padding: 35px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            margin-bottom: 30px;
        }
        .users-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px; margin-top: 25px;
        }
        .user-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            padding: 25px; border-radius: 15px; border: 2px solid #f0f0f0;
        }
        .table-section {
            background: white; padding: 35px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        .search-box { position: relative; margin-bottom: 25px; }
        .search-box input {
            width: 100%; padding: 15px 50px 15px 20px;
            border: 2px solid #e0e0e0; border-radius: 12px;
        }
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 10px;
        }
        .data-table thead th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 15px;
            text-transform: uppercase; font-size: 13px;
        }
        .data-table tbody tr {
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .data-table tbody td { padding: 15px; }
        .loading { text-align: center; padding: 60px; }
    </style>
</head>
<body>

<header class="app-header">
    <div class="header-left">
        <a href="home.html" class="brand-logo">
            <div class="brand-icon"><i class="fas fa-file-alt"></i></div>
            <span class="brand-text">Resume Builder</span>
        </a>
        <a href="home.html" class="back-button">
            <i class="fas fa-arrow-left"></i> Back to Home
        </a>
    </div>
    <div class="header-right">
        <div class="user-profile">
            <div class="profile-trigger" onclick="toggleProfileDropdown()">
                <div class="user-avatar" id="headerAvatar">U</div>
                <span class="user-name" id="headerUserName">User</span>
                <i class="fas fa-chevron-down" style="font-size: 12px; color: #666;"></i>
            </div>
            <div class="profile-dropdown" id="profileDropdown">
                <div class="dropdown-header">
                    <div class="dropdown-avatar" id="dropdownAvatar">U</div>
                    <div class="dropdown-user-info">
                        <h4 id="dropdownUserName">User</h4>
                        <p id="dropdownUserEmail">user@example.com</p>
                    </div>
                </div>
                <div class="dropdown-menu-items">
                    <a href="home.html" class="dropdown-item">
                        <i class="fas fa-home"></i>
                        <span>Home</span>
                    </a>
                    <a href="index.html" class="dropdown-item">
                        <i class="fas fa-file-alt"></i>
                        <span>Create Resume</span>
                    </a>
                    <a href="dashboard.html" class="dropdown-item">
                        <i class="fas fa-chart-line"></i>
                        <span>Analytics Dashboard</span>
                    </a>
                    <a href="job.html" class="dropdown-item">
                        <i class="fas fa-briefcase"></i>
                        <span>Post a Job</span>
                    </a>
                    <a href="jobdashboard.html" class="dropdown-item">
                        <i class="fas fa-tasks"></i>
                        <span>Job Dashboard</span>
                    </a>
                    <div class="dropdown-item logout" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>

<div class="dashboard-container">
    <div class="dashboard-header">
        <div>
            <h1><i class="fas fa-chart-line"></i> Resume Analytics Dashboard</h1>
            <p style="color: #666;">Real-time insights from your resume database</p>
        </div>
        <div style="display: flex; gap: 15px;">
            <button class="btn-action" onclick="loadDashboard()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <button class="btn-action" onclick="window.location.href='index.html'">
                <i class="fas fa-plus"></i> Create Resume
            </button>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card primary">
            <div class="stat-icon"><i class="fas fa-users"></i></div>
            <div class="stat-number" id="totalResumes">0</div>
            <div class="stat-label">Total Resumes</div>
        </div>
        <div class="stat-card success">
            <div class="stat-icon"><i class="fas fa-briefcase"></i></div>
            <div class="stat-number" id="totalWork">0</div>
            <div class="stat-label">Work Experiences</div>
        </div>
        <div class="stat-card warning">
            <div class="stat-icon"><i class="fas fa-graduation-cap"></i></div>
            <div class="stat-number" id="totalEducation">0</div>
            <div class="stat-label">Education Entries</div>
        </div>
        <div class="stat-card info">
            <div class="stat-icon"><i class="fas fa-tools"></i></div>
            <div class="stat-number" id="totalSkills">0</div>
            <div class="stat-label">Total Skills</div>
        </div>
        <div class="stat-card visitor">
            <div class="stat-icon"><i class="fas fa-eye"></i></div>
            <div class="stat-number" id="visitorCount">0</div>
            <div class="stat-label">Total Visitors</div>
        </div>
        <div class="stat-card download">
            <div class="stat-icon"><i class="fas fa-download"></i></div>
            <div class="stat-number" id="downloadCount">0</div>
            <div class="stat-label">PDF Downloads</div>
        </div>
    </div>

    <div class="chart-container">
        <div class="chart-header">
            <h3><i class="fas fa-chart-bar"></i> Visitor & Download Analytics</h3>
        </div>
        <canvas id="analyticsChart" style="max-height: 300px;"></canvas>
    </div>

    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="chart-container">
                <div class="chart-header">
                    <h3><i class="fas fa-map-marker-alt"></i> Location Distribution</h3>
                </div>
                <canvas id="locationChart"></canvas>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="chart-container">
                <div class="chart-header">
                    <h3><i class="fas fa-tools"></i> Top 10 Skills</h3>
                </div>
                <canvas id="skillsChart"></canvas>
            </div>
        </div>
    </div>

    <div class="users-cards-section">
        <div class="chart-header">
            <h3><i class="fas fa-user-friends"></i> Recent Resume Submissions</h3>
        </div>
        <div id="usersContainer">
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading resume data...</p>
            </div>
        </div>
    </div>

    <div class="table-section">
        <div class="chart-header">
            <h3><i class="fas fa-table"></i> Resume Database</h3>
        </div>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Search by name, email, location...">
            <i class="fas fa-search"></i>
        </div>
        <div style="overflow-x: auto;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Location</th>
                        <th>Experience</th>
                        <th>Education</th>
                        <th>Skills</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px;">Loading data...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script>
    const API_BASE = 'http://localhost:5000/api';
    let charts = {};
    let allData = [];
    (function() {
            'use strict';
            
            // Admin has access to ALL pages
            // Recruiter only to jobdashboard.html
            // Candidate only to dashboard.html
            const PAGE_ACCESS = {
                'home.html': ['admin'],
                'dashboard.html': ['candidate', 'admin'],
                'jobdashboard.html': ['recruiter', 'admin']
            };
            
            const currentPage = window.location.pathname.split('/').pop();
            const userType = sessionStorage.getItem('userType');
            
            if (!userType) {
                window.location.replace('login.html');
                return;
            }
            
            const allowedRoles = PAGE_ACCESS[currentPage];
            if (allowedRoles && !allowedRoles.includes(userType)) {
                const redirectMap = {
                    'candidate': 'dashboard.html',
                    'recruiter': 'jobdashboard.html',
                    'admin': 'home.html'
                };
                window.location.replace(redirectMap[userType] || 'login.html');
            }
        })();

    function initializeUserDisplay() {
        const user = sessionStorage.getItem('user');
        if (user) {
            try {
                const userData = JSON.parse(user);
                const fullName = `${userData.first_name || ''} ${userData.last_name || ''}`.trim();
                const displayName = fullName || userData.username || 'User';
                const email = userData.email || 'user@example.com';
                const initials = fullName ? fullName.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2) : 'U';
                
                document.getElementById('headerAvatar').textContent = initials;
                document.getElementById('headerUserName').textContent = displayName;
                document.getElementById('dropdownAvatar').textContent = initials;
                document.getElementById('dropdownUserName').textContent = displayName;
                document.getElementById('dropdownUserEmail').textContent = email;
            } catch (e) {}
        }
    }

    function toggleProfileDropdown() {
        const dropdown = document.getElementById('profileDropdown');
        dropdown.classList.toggle('show');
    }

    function logout() {
        sessionStorage.removeItem('user');
        sessionStorage.removeItem('token');
        window.location.href = 'login.html';
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
        const userProfile = document.querySelector('.user-profile');
        const dropdown = document.getElementById('profileDropdown');
        
        if (dropdown && !userProfile.contains(event.target)) {
            dropdown.classList.remove('show');
        }
    });

    async function fetchData() {
        try {
            const response = await fetch(`${API_BASE}/resumes`);
            const result = await response.json();
            if (result.success) {
                allData = result.data;
                return allData;
            }
            return [];
        } catch (error) {
            console.error('Error:', error);
            return [];
        }
    }

    async function fetchAnalytics() {
        try {
            const response = await fetch(`${API_BASE}/analytics`);
            const result = await response.json();
            return result.success ? result.data : { visitor_count: 0, download_count: 0 };
        } catch (error) {
            return { visitor_count: 0, download_count: 0 };
        }
    }

    function calculateStats(data) {
        const stats = {
            totalResumes: data.length,
            totalWork: 0,
            totalEducation: 0,
            totalSkills: 0,
            locations: {},
            skills: {}
        };

        data.forEach(resume => {
            stats.totalWork += resume.work_experience?.length || 0;
            stats.totalEducation += resume.education?.length || 0;
            stats.totalSkills += resume.skills?.length || 0;

            const loc = resume.personal_info?.location;
            if (loc && loc !== 'N/A') stats.locations[loc] = (stats.locations[loc] || 0) + 1;

            resume.skills?.forEach(skill => {
                if (skill.skill_name) {
                    stats.skills[skill.skill_name] = (stats.skills[skill.skill_name] || 0) + 1;
                }
            });
        });

        return stats;
    }

    function updateStats(stats, analytics) {
        document.getElementById('totalResumes').textContent = stats.totalResumes;
        document.getElementById('totalWork').textContent = stats.totalWork;
        document.getElementById('totalEducation').textContent = stats.totalEducation;
        document.getElementById('totalSkills').textContent = stats.totalSkills;
        document.getElementById('visitorCount').textContent = analytics.visitor_count;
        document.getElementById('downloadCount').textContent = analytics.download_count;
    }

    function createAnalyticsChart(analytics) {
        if (charts.analytics) charts.analytics.destroy();
        const ctx = document.getElementById('analyticsChart');
        charts.analytics = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Visitors', 'Downloads'],
                datasets: [{
                    label: 'Count',
                    data: [analytics.visitor_count, analytics.download_count],
                    backgroundColor: ['rgba(250, 139, 255, 0.8)', 'rgba(249, 119, 148, 0.8)']
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function createLocationChart(locations) {
        if (charts.location) charts.location.destroy();
        const sorted = Object.entries(locations).sort((a, b) => b[1] - a[1]).slice(0, 10);
        if (sorted.length === 0) return;
        const ctx = document.getElementById('locationChart');
        charts.location = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: sorted.map(l => l[0]),
                datasets: [{
                    label: 'Number of Users',
                    data: sorted.map(l => l[1]),
                    backgroundColor: 'rgba(102, 126, 234, 0.8)'
                }]
            },
            options: { responsive: true }
        });
    }

    function createSkillsChart(skills) {
        if (charts.skills) charts.skills.destroy();
        const sorted = Object.entries(skills).sort((a, b) => b[1] - a[1]).slice(0, 10);
        if (sorted.length === 0) return;
        const ctx = document.getElementById('skillsChart');
        charts.skills = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: sorted.map(s => s[0]),
                datasets: [{
                    label: 'Frequency',
                    data: sorted.map(s => s[1]),
                    backgroundColor: 'rgba(118, 75, 162, 0.8)'
                }]
            },
            options: { indexAxis: 'y', responsive: true }
        });
    }

    function displayUsers(data) {
        const container = document.getElementById('usersContainer');
        if (data.length === 0) {
            container.innerHTML = '<div class="loading"><p>No resumes found</p></div>';
            return;
        }
        const recentData = data.slice(0, 6);
        container.innerHTML = `<div class="users-grid">${recentData.map(resume => {
            const name = resume.personal_info?.full_name || 'Unknown';
            const email = resume.personal_info?.email || 'No email';
            const location = resume.personal_info?.location || 'N/A';
            return `<div class="user-card">
                <h4>${name}</h4>
                <p><i class="fas fa-envelope"></i> ${email}</p>
                <p><i class="fas fa-map-marker-alt"></i> ${location}</p>
                <p><i class="fas fa-briefcase"></i> ${resume.work_experience?.length || 0} experiences</p>
                <p><i class="fas fa-tools"></i> ${resume.skills?.length || 0} skills</p>
            </div>`;
        }).join('')}</div>`;
    }

    function displayTable(data) {
        const tbody = document.getElementById('tableBody');
        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No resumes found</td></tr>';
            return;
        }
        tbody.innerHTML = data.map(resume => {
            const name = resume.personal_info?.full_name || 'Unknown';
            const email = resume.personal_info?.email || 'No email';
            const location = resume.personal_info?.location || 'N/A';
            const workExp = resume.work_experience?.length || 0;
            const education = resume.education?.length || 0;
            const skillsCount = resume.skills?.length || 0;
            return `<tr>
                <td>${name}</td>
                <td>${email}</td>
                <td>${location}</td>
                <td>${workExp}</td>
                <td>${education}</td>
                <td>${skillsCount}</td>
            </tr>`;
        }).join('');
    }

    document.addEventListener('DOMContentLoaded', function() {
        initializeUserDisplay();
        
        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const filtered = allData.filter(resume => {
                const name = (resume.personal_info?.full_name || '').toLowerCase();
                const email = (resume.personal_info?.email || '').toLowerCase();
                const location = (resume.personal_info?.location || '').toLowerCase();
                return name.includes(searchTerm) || email.includes(searchTerm) || location.includes(searchTerm);
            });
            displayTable(filtered);
        });

        loadDashboard();
    });

    async function loadDashboard() {
        const [data, analytics] = await Promise.all([fetchData(), fetchAnalytics()]);
        const stats = calculateStats(data);
        updateStats(stats, analytics);
        createAnalyticsChart(analytics);
        createLocationChart(stats.locations);
        createSkillsChart(stats.skills);
        displayUsers(data);
        displayTable(data);
    }
</script>
</body>
</html>